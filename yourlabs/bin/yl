#!/usr/bin/env python
import sys
import os
import subprocess

import yourlabs


def run(cmd):
    cmd = u' '.join(cmd)
    print '[yl] Running command: %s' % cmd
    output = subprocess.check_output(cmd, shell=True)
    print output.replace('django-admin.py startproject', 'yl')


def main():
    if sys.argv[1] == 'help':
        run(['django-admin.py', 'help', 'startproject'])
        sys.exit(0)

    cmd=['django-admin.py', 'startproject']
    cmd+=sys.argv[1:-1]
    cmd.append('--template=%s' % os.path.realpath(
        os.path.join(yourlabs.__path__[0], 'project_template')))
    cmd.append(sys.argv[-1])

    run(cmd)

    project_path = os.path.join(os.getcwd(), sys.argv[-1])
    if os.path.exists(project_path):
        print '[yl] Project successfully created: %s' % project_path
        print '[yl] Installing requirements ...'
        subprocess.call(['pip', 'install', '-r', os.path.join(
            project_path, 'requirements', 'base.txt')])
        print '[yl] Setting up the database ...'
        subprocess.call([os.path.join(project_path, 'manage.py'), 'syncdb',
                         '--noinput'])
        subprocess.call([os.path.join(project_path, 'manage.py'), 'migrate',
                         '--noinput'])

        print '[yl] Creating a superuser with username=test and'
        print '[yl] email=test@example.com, type in password and enter'
        print '[yl] or exit with Ctrl+C'

        try:
            subprocess.call([os.path.join(project_path, 'manage.py'),
                            'createsuperuser', '--username=test',
                             '--email=test@example.com'])
        except KeyboardInterrupt:
            print ''
            print ''
            print ''
            print 'Superuser creation aborded'

    else:
        sys.exit(1)

if __name__ == "__main__":
    main()
